
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Reader</title>
    
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- DataTables CSS and JS -->
    <link href="https://cdn.datatables.net/v/dt/dt-2.3.4/datatables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/v/dt/dt-2.3.4/datatables.min.js"></script>
    
    <!-- Bootstrap for better styling (optional) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            padding: 20px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .file-input {
            margin-bottom: 10px;
        }
        #csvSelect {
            margin-bottom: 10px;
        }
        #dataTable_wrapper {
            margin-top: 20px;
        }
        /* Force Bootstrap table-sm to work with DataTables */
        .table-sm td,
        .table-sm th {
            padding: 0.25rem !important;
        }
        
        /* Additional condensing for DataTables specifically */
        table.dataTable.table-sm tbody td,
        table.dataTable.table-sm thead th {
            padding: 0.25rem !important;
        }
        
        /* Cell color classes based on values */
        .value-300 {
            background-color: #fff3cd !important; /* Light yellow */
        }
        .value-400 {
            background-color: #ffeaa7 !important; /* Yellow */
        }
        .value-500 {
            background-color: #fab1a0 !important; /* Light orange */
        }
        .value-600 {
            background-color: #e17055 !important; /* Orange */
        }
        .value-700 {
            background-color: #d63031 !important; /* Red */
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3>CSV Log Reader</h3>
        
        <div class="controls">
            <div class="file-input">
                <div class="input-group">
                    <input type="text" id="directoryPath" class="form-control" placeholder="Type directory path here..." value="">
                    <button class="btn btn-primary" type="button" id="loadDirectoryBtn">Load Directory</button>
                </div>
            </div>
            
            <div class="file-input">
                <input type="file" id="directoryInput" webkitdirectory directory multiple class="form-control">
            </div>
            
            <div>
                <select id="csvSelect" class="form-select" disabled>
                    <option value="">Select CSV File</option>
                </select>
            </div>
        </div>
        
        <div id="tableContainer">
            <table id="dataTable" class="display table table-striped  table-sm" style="width:100%">
                <thead>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let dataTable;
        let csvFiles = [];

        // Handle directory path input
        document.getElementById('loadDirectoryBtn').addEventListener('click', function() {
            const directoryPath = document.getElementById('directoryPath').value.trim();
            if (!directoryPath) {
                alert('Please enter a directory path');
                return;
            }
            
            // For local development, try to load files from the specified path
            loadFromDirectoryPath(directoryPath);
        });

        // Load files from directory path (works for relative paths served by a web server)
        async function loadFromDirectoryPath(path) {
            try {
                // If it's a relative path like "./data", try to load known files
                if (path === './data' || path === 'data' || path.endsWith('/data') || path.endsWith('\\data')) {
                    const knownFiles = [
                        'a_1crawler_web.log',
                        'a_2markdown_cleanup.log', 
                        'a_3chunker.log',
                        'a_6vector.log',
                        'tokencount_csv.log'
                    ];
                    
                    csvFiles = [];
                    const select = document.getElementById('csvSelect');
                    select.innerHTML = '<option value="">Select a CSV file...</option>';
                    
                    for (let i = 0; i < knownFiles.length; i++) {
                        const fileName = knownFiles[i];
                        const filePath = path + '/' + fileName;
                        
                        try {
                            // Test if file exists by trying to fetch it
                            const response = await fetch(filePath);
                            if (response.ok) {
                                csvFiles.push({
                                    name: fileName,
                                    path: filePath,
                                    isUrl: true
                                });
                                
                                const option = document.createElement('option');
                                option.value = csvFiles.length - 1;
                                option.textContent = fileName;
                                select.appendChild(option);
                            }
                        } catch (e) {
                            // File doesn't exist or can't be accessed
                            console.log(`Could not load ${fileName}`);
                        }
                    }
                    
                    if (csvFiles.length > 0) {
                        select.disabled = false;
                        alert(`Found ${csvFiles.length} CSV/log files in the directory`);
                    } else {
                        alert('No accessible CSV/log files found in the specified directory. Make sure you are serving this page from a web server.');
                    }
                } else {
                    alert('For security reasons, browsers cannot directly access arbitrary file system paths. Please use the file browser option below, or serve this page from a web server with your files in a relative path like "./data"');
                }
            } catch (error) {
                console.error('Error loading directory:', error);
                alert('Error loading directory. Please use the file browser option below.');
            }
        }

        // Handle directory selection via file input
        document.getElementById('directoryInput').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            csvFiles = files.filter(file => 
                file.name.toLowerCase().endsWith('.csv') || 
                file.name.toLowerCase().endsWith('.log')
            ).map(file => ({
                name: file.name,
                file: file,
                isUrl: false
            }));
            
            populateCSVDropdown();
        });

        // Populate CSV dropdown
        function populateCSVDropdown() {
            const select = document.getElementById('csvSelect');
            select.innerHTML = '<option value="">Select a CSV file...</option>';
            
            if (csvFiles.length === 0) {
                select.innerHTML = '<option value="">No CSV/log files found</option>';
                select.disabled = true;
                return;
            }
            
            csvFiles.forEach((fileObj, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = fileObj.name;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        // Handle CSV file selection
        document.getElementById('csvSelect').addEventListener('change', function(event) {
            const fileIndex = event.target.value;
            if (fileIndex === '') return;
            
            const selectedFileObj = csvFiles[fileIndex];
            loadCSVFile(selectedFileObj);
        });

        // Load and parse CSV file
        function loadCSVFile(fileObj) {
            if (fileObj.isUrl) {
                // Load from URL/path
                fetch(fileObj.path)
                    .then(response => response.text())
                    .then(csvContent => parseCSV(csvContent))
                    .catch(error => {
                        console.error('Error loading file:', error);
                        alert('Error loading file: ' + fileObj.name);
                    });
            } else {
                // Load from File object
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvContent = e.target.result;
                    parseCSV(csvContent);
                };
                reader.readAsText(fileObj.file);
            }
        }

        // Parse CSV content
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return;
            
            // Find the header line (look for line with comma-separated values)
            let headerIndex = -1;
            let headers = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // Skip lines that don't look like CSV data
                if (line.includes('Token count analysis') || 
                    line.includes('Using tiktoken') || 
                    line.includes('====')) {
                    continue;
                }
                
                // Try to parse as CSV
                if (line.includes(',')) {
                    headers = parseCSVLine(line);
                    headerIndex = i;
                    break;
                }
            }
            
            if (headerIndex === -1 || headers.length === 0) {
                alert('Could not find valid CSV headers in the file');
                return;
            }
            
            // Parse data rows
            const data = [];
            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                const row = parseCSVLine(line);
                if (row.length > 0) {
                    // Ensure row has same number of columns as headers
                    while (row.length < headers.length) {
                        row.push('');
                    }
                    data.push(row);
                }
            }
            
            createDataTable(headers, data);
        }

        // Parse a single CSV line, handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            return result;
        }

        // Create/recreate DataTable
        function createDataTable(headers, data) {
            // Destroy existing DataTable if it exists
            if (dataTable) {
                dataTable.destroy();
            }
            
            // Clear table
            const table = document.getElementById('dataTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Create data rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    
                    // Apply color coding based on numeric values
                    const numValue = parseFloat(cell);
                    if (!isNaN(numValue)) {
                        if (numValue >= 700) {
                            td.classList.add('value-700');
                        } else if (numValue >= 600) {
                            td.classList.add('value-600');
                        } else if (numValue >= 500) {
                            td.classList.add('value-500');
                        } else if (numValue >= 400) {
                            td.classList.add('value-400');
                        } else if (numValue >= 300) {
                            td.classList.add('value-300');
                        }
                    }
                    
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // Initialize DataTable with default settings (includes sorting and search)
            dataTable = new DataTable('#dataTable', {
                pageLength: 200,
                lengthMenu: [50, 100, 200, 400],
                order: [], // No default ordering
                columnDefs: [
                    { targets: '_all', className: 'dt-left' }
                ]
            });
            // Add Bootstrap's table-sm class for compact styling
            document.getElementById('dataTable').classList.add('table-sm');
        }

        // Initialize page
        $(document).ready(function() {
            console.log('CSV Log Reader initialized');
        });
    </script>
</body>
</html>