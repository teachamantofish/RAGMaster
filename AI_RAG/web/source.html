<section class="source-fragment">

    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables CSS and JS -->
    <link href="https://cdn.datatables.net/v/dt/dt-2.3.4/datatables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/3.1.1/css/buttons.dataTables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.2/css/buttons.dataTables.min.css" />
    <link href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" rel="stylesheet">
    <!-- Optional Bootstrap for nicer defaults -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/custom_data_tables.css">

    <script src="https://cdn.datatables.net/v/dt/dt-2.3.4/datatables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> <!-- For Excel export -->
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"></script> <!-- For Excel/CSV buttons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script> <!-- For PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"></script> <!-- For Print button -->

    <div class="container-fluid">
        <h5>Data sources +metadata</h5>
        <div id="status">Loading data...</div>

        <table id="dataTable" class="display table table-striped table-sm">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        (function initSourceFragment() {
            const defaultConfig = {
                tableSelector: '#tab-content-source #dataTable, #dataTable',
                statusSelector: '#tab-content-source #status, #status',
                checkBoxes: true,
                saveButton: true,
                onSave(context) {
                    if (window.SourceActions && typeof window.SourceActions.handleSave === 'function') {
                        window.SourceActions.handleSave(context);
                    } else {
                        console.info('[source-tab] Save button clicked but no handler is available.', context);
                    }
                },
                yaml: true,
                qa: false,
                printPDF: false,
                exportExcel: false,
                emailButton: false
            };

            function applyConfig(config, attempt = 0) {
                if (!window.SourceTable || typeof window.SourceTable.configure !== 'function') {
                    if (attempt > 40) return;
                    return window.setTimeout(() => applyConfig(config, attempt + 1), 50);
                }

                window.SourceTable.configure(config);
                if (typeof window.SourceTable.loadSourceTab === 'function') {
                    window.SourceTable.loadSourceTab(true);
                }
            }

            async function initialize() {
                const statusEl = document.querySelector(defaultConfig.statusSelector);

                try {
                    if (!window.AppConfig || typeof window.AppConfig.ready !== 'function') {
                        throw new Error('Configuration loader unavailable');
                    }

                    await window.AppConfig.ready();
                    const pathConfig = window.AppConfig.get('source.metadata');
                    if (!pathConfig) {
                        throw new Error('Missing source.metadata configuration');
                    }

                    const mergedConfig = Object.assign({}, defaultConfig, pathConfig);
                    if (!mergedConfig.displayName) {
                        mergedConfig.displayName = mergedConfig.preloadedKey || 'Metadata Config';
                    }

                    applyConfig(mergedConfig);
                } catch (error) {
                    console.error('[source-tab] Failed to initialize source fragment:', error);
                    if (statusEl) {
                        statusEl.textContent = `Failed to initialize: ${error.message}`;
                    }
                }
            }

            initialize();
        })();
    </script>
</section>
